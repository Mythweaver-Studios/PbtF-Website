<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voiceline Timing Helper</title>
    <!-- WaveSurfer.js from a CDN. This is stable and reliable. -->
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <style>
        :root {
            --bg-dark: #100e0c;
            --bg-light: #1a1612;
            --bg-lighter: #2c251d;
            --text-primary: #e0c9a6;
            --text-secondary: #a89a85;
            --accent-gold: #f1c40f;
            --accent-red: #e74c3c;
            --border-color: rgba(207, 181, 130, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            padding: 2rem;
        }

        .app-container {
            max-width: 900px;
            margin: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .card {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        h1, h2 {
            color: var(--accent-gold);
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        p {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        label {
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 0.5rem;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

            input[type="text"]:focus, textarea:focus {
                border-color: var(--accent-gold);
                box-shadow: 0 0 10px rgba(241, 196, 15, 0.3);
                outline: none;
            }

        textarea {
            font-family: 'Courier New', Courier, monospace;
            resize: vertical;
        }

        button {
            background-color: transparent;
            color: var(--accent-gold);
            border: 2px solid var(--accent-gold);
            padding: 0.7rem 1.5rem;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

            button:hover:not(:disabled) {
                background-color: var(--accent-gold);
                color: var(--bg-dark);
                box-shadow: 0 0 15px var(--accent-gold);
            }

            button:disabled {
                border-color: var(--text-secondary);
                color: var(--text-secondary);
                opacity: 0.5;
                cursor: not-allowed;
            }

            button.active {
                background-color: var(--accent-gold);
                color: var(--bg-dark);
            }

            button.danger {
                border-color: var(--accent-red);
                color: var(--accent-red);
            }

                button.danger:hover:not(:disabled) {
                    background-color: var(--accent-red);
                    color: #fff;
                    box-shadow: 0 0 15px var(--accent-red);
                }

        .controls, .audio-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .audio-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding: 0 0.5rem;
            font-family: 'Courier New', Courier, monospace;
        }

        #waveform {
            width: 100%;
            background-color: var(--bg-dark);
            border-radius: 4px;
            margin-top: 0.5rem;
        }

        #words-display {
            padding: 1rem;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
            margin-top: 1.5rem;
            min-height: 50px;
            line-height: 2;
            display: flex;
            flex-wrap: wrap;
        }

            #words-display span {
                font-size: 1.2rem;
                font-weight: bold;
                margin: 4px;
                padding: 4px 8px;
                border-radius: 4px;
                transition: all 0.2s;
            }

                #words-display span.completed {
                    background-color: var(--bg-lighter);
                }

                #words-display span.current {
                    background-color: var(--accent-gold);
                    color: var(--bg-dark);
                    box-shadow: 0 0 10px var(--accent-gold);
                }

                #words-display span.editable:hover {
                    background-color: var(--accent-red);
                    color: #fff;
                    cursor: pointer;
                }

        #status {
            font-weight: bold;
            color: var(--text-primary);
            transition: color 0.2s;
        }

            #status.error {
                color: var(--accent-red);
            }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="card">
            <h1>Voiceline Timing Helper by Solo</h1>
            <p>A stable and reliable tool to generate the `timedQuote` JSON for character voicelines.</p>
        </div>

        <div class="card">
            <h2>1. Setup</h2>
            <div class="audio-controls">
                <input type="file" id="audioFile" accept="audio/*" style="flex-grow: 1;">
                <button id="playBtn" disabled>Play / Pause</button>
                <button id="autoplayBtn" disabled>Autoplay</button>
            </div>
            <div class="audio-info">
                <span id="status">Load an audio file to begin.</span>
                <span id="time-display">0.00s / 0.00s</span>
            </div>
            <div id="waveform"></div>
            <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
            <label for="quoteText">Quote Text</label>
            <input type="text" id="quoteText" placeholder="Listen to the audio and paste the full quote here...">
        </div>

        <div class="card">
            <h2>2. Timing Control</h2>
            <p>Once the quote is set, click "Play" and use the <strong>G key</strong> or the <strong>Mark Word button</strong> to time each word.</p>
            <div class="controls">
                <button id="markBtn" disabled>Mark Word (G)</button>
                <button id="resetTimingsBtn" class="danger" disabled>Reset Timings</button>
                <button id="resetAllBtn" class="danger">Reset All</button>
            </div>
            <div id="words-display"></div>
        </div>

        <div class="card">
            <div class="output-header">
                <h2>3. Result (JSON)</h2>
                <button id="copyBtn" disabled>Copy to Clipboard</button>
            </div>
            <p>When finished, the result will appear here. You can click a word in the box above to edit its timing.</p>
            <textarea id="output" rows="12" readonly></textarea>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            /* global WaveSurfer */
            const elements = {
                audioFile: document.getElementById('audioFile'),
                quoteText: document.getElementById('quoteText'),
                playBtn: document.getElementById('playBtn'),
                autoplayBtn: document.getElementById('autoplayBtn'),
                markBtn: document.getElementById('markBtn'),
                resetTimingsBtn: document.getElementById('resetTimingsBtn'),
                resetAllBtn: document.getElementById('resetAllBtn'),
                copyBtn: document.getElementById('copyBtn'),
                waveform: document.getElementById('waveform'),
                wordsDisplay: document.getElementById('words-display'),
                output: document.getElementById('output'),
                status: document.getElementById('status'),
                timeDisplay: document.getElementById('time-display'),
            };

            let waveSurfer;
            let words = [];
            let timings = [];
            let currentIndex = 0;
            let isAutoplay = false;

            function initialize() {
                waveSurfer = WaveSurfer.create({
                    container: elements.waveform,
                    waveColor: '#f1c40f',
                    progressColor: '#f1c40f',
                    cursorColor: '#e74c3c',
                    barWidth: 3,
                    barRadius: 3,
                    height: 128,
                    responsive: true,
                    interact: true,
                });

                waveSurfer.on('ready', () => {
                    updateUIState();
                    updateTimeDisplay();
                    elements.status.textContent = 'Audio ready. Paste quote to enable timing.';
                });
                waveSurfer.on('audioprocess', updateTimeDisplay);
                waveSurfer.on('seek', updateTimeDisplay);
                waveSurfer.on('play', updateUIState);
                waveSurfer.on('pause', updateUIState);
                waveSurfer.on('finish', () => {
                    elements.status.textContent = 'Finished! Click a word to edit timing.';
                    if (isAutoplay) {
                        waveSurfer.play();
                    }
                });
            }

            function updateTimeDisplay() {
                if (!waveSurfer) return;
                const currentTime = waveSurfer.getCurrentTime().toFixed(2);
                const totalDuration = waveSurfer.getDuration().toFixed(2);
                elements.timeDisplay.textContent = `${currentTime}s / ${totalDuration}s`;
            }

            function resetAll() {
                elements.quoteText.value = '';
                elements.audioFile.value = '';
                if (waveSurfer) waveSurfer.empty();
                resetTimings();
                elements.timeDisplay.textContent = '0.00s / 0.00s';
                updateUIState();
            }

            function resetTimings() {
                timings = [];
                currentIndex = 0;
                words = (elements.quoteText.value || '').replace(/[^a-zA-Z\s']/g, "").split(' ').filter(w => w);
                elements.output.value = '';
                renderWords();
                updateUIState();
            }

            function renderWords() {
                elements.wordsDisplay.innerHTML = '';
                words.forEach((word, index) => {
                    const span = document.createElement('span');
                    span.textContent = word;
                    if (index < currentIndex) span.classList.add('completed');
                    if (index === currentIndex) span.classList.add('current');
                    elements.wordsDisplay.appendChild(span);
                });
            }

            function updateUIState() {
                const isAudioLoaded = waveSurfer && waveSurfer.getDuration() > 0;
                const isQuoteReady = words.length > 0;
                const isPlaying = waveSurfer && waveSurfer.isPlaying();

                elements.playBtn.disabled = !isAudioLoaded;
                elements.autoplayBtn.disabled = !isAudioLoaded;
                elements.markBtn.disabled = !isAudioLoaded || !isQuoteReady;
                elements.resetTimingsBtn.disabled = timings.length === 0;
                elements.copyBtn.disabled = timings.length !== words.length || !isQuoteReady;

                elements.status.classList.remove('error');
                if (!isAudioLoaded) {
                    elements.status.innerHTML = 'Load an audio file to begin.';
                } else if (!isQuoteReady) {
                    elements.status.innerHTML = 'Audio loaded. Paste the full quote to enable timing.';
                } else if (!isPlaying) {
                    elements.status.innerHTML = 'Ready to time. Press Play, then use the (G) key or button.';
                } else {
                    elements.status.innerHTML = `Timing word ${currentIndex + 1} of ${words.length}...`;
                }
            }

            function markWord() {
                if (!waveSurfer.isPlaying() || currentIndex >= words.length || words.length === 0) return;

                timings.push(waveSurfer.getCurrentTime());
                currentIndex++;
                renderWords();

                if (currentIndex >= words.length) {
                    waveSurfer.pause();
                    generateOutput();
                    makeWordsEditable();
                }
                updateUIState();
            }

            function generateOutput() {
                const timedQuote = words.map((word, index) => {
                    const startTime = timings[index - 1] || 0;
                    const endTime = timings[index];
                    const duration = Math.round((endTime - startTime) * 1000);
                    return { word, duration };
                });
                elements.output.value = JSON.stringify(timedQuote, null, 2);
                updateUIState();
            }

            function makeWordsEditable() {
                Array.from(elements.wordsDisplay.children).forEach((span, index) => {
                    span.classList.add('editable');
                    span.onclick = () => editTiming(index);
                });
            }

            function editTiming(index) {
                const originalTime = timings[index].toFixed(3);
                const newTimeStr = prompt(`Editing timing for word "${words[index]}".\nEnter the new END time in seconds (current: ${originalTime}s).`, originalTime);

                if (newTimeStr !== null) {
                    const newTime = parseFloat(newTimeStr);
                    if (!isNaN(newTime) && newTime > (timings[index - 1] || 0)) {
                        timings[index] = newTime;
                        timings.sort((a, b) => a - b);
                        generateOutput();
                        alert('Timings updated!');
                    } else {
                        alert('Invalid time. Must be a number greater than the previous word\'s time.');
                    }
                }
            }

            elements.audioFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    elements.status.innerHTML = 'Decoding waveform...';
                    waveSurfer.load(URL.createObjectURL(file));
                    resetTimings();
                }
            });

            elements.quoteText.addEventListener('input', resetTimings);
            elements.playBtn.addEventListener('click', () => waveSurfer.playPause());
            elements.autoplayBtn.addEventListener('click', () => {
                isAutoplay = !isAutoplay;
                elements.autoplayBtn.classList.toggle('active', isAutoplay);
                if (isAutoplay && !waveSurfer.isPlaying()) {
                    waveSurfer.play();
                }
            });
            elements.markBtn.addEventListener('click', markWord);
            elements.resetTimingsBtn.addEventListener('click', resetTimings);
            elements.resetAllBtn.addEventListener('click', resetAll);

            elements.copyBtn.addEventListener('click', () => {
                elements.output.select();
                document.execCommand('copy');
                elements.copyBtn.textContent = 'Copied!';
                setTimeout(() => { elements.copyBtn.textContent = 'Copy to Clipboard'; }, 1500);
            });

            document.addEventListener('keydown', (e) => {
                if (e.code === 'KeyG' && !elements.markBtn.disabled) {
                    e.preventDefault();
                    markWord();
                }
            });

            initialize();
        });
    </script>
</body>
</html>